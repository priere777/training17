<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚æ‹è¨˜éŒ²ãƒãƒƒãƒ”ãƒ³ã‚°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --main-red: #8e1d1d; }
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f4f1ea; display: flex; flex-direction: column; height: 100vh; }
        #map { width: 100%; height: 40vh; flex-shrink: 0; border-bottom: 3px solid var(--main-red); background: #eee; }
        .ui-panel { flex-grow: 1; overflow-y: auto; padding: 20px; box-sizing: border-box; background: white; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8em; color: #666; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-save { background: var(--main-red); color: white; border: none; padding: 15px; border-radius: 30px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1em; }
        .nav-link { display: block; text-align: center; margin-top: 15px; color: #666; text-decoration: none; font-size: 0.9em; padding-bottom: 30px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
    <div class="input-group">
        <label>â›©ï¸ ç¥ç¤¾å</label>
        <input type="text" id="shrine-name" placeholder="ä¾‹ï¼šå°ç¶²" oninput="autoCheck()">
    </div>
    <div class="input-group">
        <label>ğŸ“… å‚æ‹æ—¥</label>
        <input type="date" id="visit-date">
    </div>
    <div class="input-group">
        <label>ğŸ“¸ å†™çœŸï¼ˆå¾¡æœ±å°ã‚„å¢ƒå†…ã®æ§˜å­ï¼‰</label>
        <input type="file" id="shrine-photo" accept="image/*">
    </div>
    <div class="input-group">
        <label>ğŸ™ å¾¡ç¥­ç¥ / å±æ€§</label>
        <input type="text" id="deity-name" placeholder="ç¥æ§˜ã®åå‰" style="margin-bottom: 8px;">
        <select id="shrine-cat">
            <option value="fortune">é‡‘é‹ãƒ»ãƒ“ã‚¸ãƒã‚¹é‹</option>
            <option value="purification">æµ„åŒ–ãƒ»ãƒªã‚»ãƒƒãƒˆ</option>
            <option value="stability">åœ°ç›¤ãƒ»å®‰å®šåŠ›</option>
            <option value="network">ã”ç¸ãƒ»ç¹‹ãŒã‚Š</option>
            <option value="creative">æ‰èƒ½ãƒ»ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–</option>
            <option value="breakthrough">é–‹æ‹“ãƒ»çªç ´åŠ›</option>
        </select>
    </div>
    <button class="btn-save" onclick="saveVisit()">ğŸ™ å‚æ‹ã‚’è¨˜éŒ²ã™ã‚‹</button>
    <a href="index.html" class="nav-link">â” ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã¸æˆ»ã‚‹</a>
</div>

<script>
    const colors = {
        fortune: "#f1c40f",      // é‡‘é‹ï¼šé»„
        purification: "#3498db", // æµ„åŒ–ï¼šé’
        stability: "#27ae60",    // åœ°ç›¤ï¼šç·‘
        network: "#e91e63",      // ã”ç¸ï¼šæ¡ƒ
        creative: "#9b59b6",     // æ‰èƒ½ï¼šç´«
        breakthrough: "#e67e22"  // é–‹æ‹“ï¼šæ©™
    };

    const shrineMaster = {
        "æ˜æ²»ç¥å®®": { cat: "stability", deity: "æ˜æ²»å¤©çš‡", lat: 35.6763, lng: 139.6993 },
        "å°ç¶²ç¥ç¤¾": { cat: "fortune", deity: "å€‰ç¨²é­‚ç¥", lat: 35.6853, lng: 139.7792 },
        "ç¥ç”°æ˜ç¥": { cat: "purification", deity: "å¤§å·±è²´å‘½", lat: 35.7020, lng: 139.7680 }
    };

    var map;
    document.getElementById('visit-date').valueAsDate = new Date();

    window.onload = function() {
        map = L.map('map').setView([35.6895, 139.6917], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        showHistoryMarkers();
        setTimeout(() => { map.invalidateSize(); }, 400);
    };

    // ğŸ’¡ å±¥æ­´ã‚’è‰²ä»˜ãã®ä¸¸ï¼ˆã‚µãƒ¼ã‚¯ãƒ«ï¼‰ã§è¡¨ç¤ºã™ã‚‹
    function showHistoryMarkers() {
        const history = JSON.parse(localStorage.getItem('shrine_history') || '[]');
        history.forEach(item => {
            const master = Object.entries(shrineMaster).find(([k]) => item.name.includes(k.replace(/ç¥ç¤¾|å¤§ç¤¾|ç¥å®®/g, '')));
            if (master) {
                const color = colors[item.category] || "#888";
                L.circleMarker([master[1].lat, master[1].lng], {
                    radius: 10,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`${item.name}<br>${item.date}`);
            }
        });
    }

    function autoCheck() {
        let name = document.getElementById('shrine-name').value;
        const match = Object.entries(shrineMaster).find(([k]) => k.includes(name.replace(/ç¥ç¤¾|å¤§ç¤¾|ç¥å®®/g, '')));
        if (match && name.length > 1) {
            document.getElementById('deity-name').value = match[1].deity;
            document.getElementById('shrine-cat').value = match[1].cat;
            map.flyTo([match[1].lat, match[1].lng], 15);
        }
    }

    function saveVisit() {
        const name = document.getElementById('shrine-name').value;
        if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­");
        const photoFile = document.getElementById('shrine-photo').files[0];
        if (photoFile) {
            const reader = new FileReader();
            reader.onload = function(e) { completeSave(e.target.result); };
            reader.readAsDataURL(photoFile);
        } else {
            completeSave(null);
        }
    }

    function completeSave(photoData) {
        let history = JSON.parse(localStorage.getItem('shrine_history') || '[]');
        history.push({
            name: document.getElementById('shrine-name').value,
            date: document.getElementById('visit-date').value,
            deity: document.getElementById('deity-name').value,
            category: document.getElementById('shrine-cat').value,
            photo: photoData
        });
        localStorage.setItem('shrine_history', JSON.stringify(history));
        alert("è‰²ä»˜ããƒ”ãƒ³ã§è¨˜éŒ²ã—ãŸã‚ˆï¼");
        location.href = "index.html";
    }
</script>
</body>
</html>